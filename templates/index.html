<!DOCTYPE html>
<html>
<head>
    <title>Car Controller</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .joystick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 25vh;
        }
        #joystick {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #ddd;
            border-radius: 50%;
        }
        #handle {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #bbb;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <h1>Car Controller</h1>

    <h2>Joystick</h2>
    <p>Click and drag the joystick to move the car.</p>

    <div class="joystick-container">
        <div id="joystick">
            <div id="handle"></div>
        </div>
    </div>

    <h2>Camera Feed</h2>
    <img id="camera-feed" src="/capture" alt="Camera feed" onerror="handleCameraError(this);">

    <script>
        var joystick = document.getElementById('joystick');
        var handle = document.getElementById('handle');
        var moveInterval;

        joystick.addEventListener('mousedown', startMove);
        joystick.addEventListener('touchstart', startMove);

        document.addEventListener('mouseup', stopMove);
        document.addEventListener('touchend', stopMove);

        function startMove(event) {
            event.preventDefault();
            moveHandle(event);
            document.addEventListener('mousemove', moveHandle);
            document.addEventListener('touchmove', moveHandle);
        }

        function stopMove() {
            handle.style.top = '50%';
            handle.style.left = '50%';
            document.removeEventListener('mousemove', moveHandle);
            document.removeEventListener('touchmove', moveHandle);
            stopMoveCar();
        }

        function moveHandle(event) {
            var rect = joystick.getBoundingClientRect();
            var clientX = event.clientX || event.touches[0].clientX;
            var clientY = event.clientY || event.touches[0].clientY;
            var x = clientX - rect.left - handle.offsetWidth / 2;
            var y = clientY - rect.top - handle.offsetHeight / 2;
            var direction = Math.atan2(y - joystick.offsetHeight / 2, x - joystick.offsetWidth / 2);
            if (direction > -Math.PI / 4 && direction < Math.PI / 4) {
                startMoveCar('right');
            } else if (direction > Math.PI / 4 && direction < 3 * Math.PI / 4) {
                startMoveCar('backward');
            } else if (direction < -Math.PI / 4 && direction > -3 * Math.PI / 4) {
                startMoveCar('forward');
            } else {
                startMoveCar('left');
            }
            handle.style.top = y + 'px';
            handle.style.left = x + 'px';
        }

        function startMoveCar(direction) {
            clearInterval(moveInterval);
            moveInterval = setInterval(function() {
                $.get('/move/' + direction);
            }, 100);
        }

        function stopMoveCar() {
            clearInterval(moveInterval);
            $.get('/move/stop');
        }

        function handleCameraError(imageElement) {
            // Replace the camera feed with a default image
            // imageElement.src = '/default.png';
            // Or display an error message
            imageElement.alt = 'Camera feed not available';
        }

        // Refresh the camera feed every second
        setInterval(function() {
            $('#camera-feed').attr('src', '/capture?' + new Date().getTime());
        }, 500);
    </script>
</body>
</html>