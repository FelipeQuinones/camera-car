<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Controller</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .joystick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 25vh;
        }
        .joystick {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #ddd;
            border-radius: 50%;
        }
        .handle {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #bbb;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <h1>Car Controller</h1>

    <h2>Joystick</h2>
    <p>Click and drag the joystick to move the car.</p>

    <div class="joystick-container">
        <div id="joystick" class="joystick">
            <div id="handle" class="handle"></div>
        </div>
    </div>

    <div class="joystick-container">
        <div id="joystick2" class="joystick">
            <div id="handle2" class="handle"></div>
        </div>
    </div>

    <h2>Camera Feed</h2>
    <img src="{{ url_for('video_feed') }}" style="width:100%;" />

    <script>
        var joystick = document.getElementById('joystick');
        var handle = document.getElementById('handle');
        var joystick2 = document.getElementById('joystick2');
        var handle2 = document.getElementById('handle2');
        var moveInterval;

        joystick.addEventListener('mousedown', startMove);
        joystick.addEventListener('touchstart', startMove);

        joystick2.addEventListener('mousedown', moveHandle2);
        joystick2.addEventListener('touchstart', moveHandle2);

        document.addEventListener('mouseup', stopMove);
        document.addEventListener('touchend', stopMove);

        function startMove(event) {
            event.preventDefault();
            moveHandle(event);
            document.addEventListener('mousemove', moveHandle);
            document.addEventListener('touchmove', moveHandle);
        }

        function stopMove() {
            handle.style.top = '50%';
            handle.style.left = '50%';
            document.removeEventListener('mousemove', moveHandle);
            document.removeEventListener('touchmove', moveHandle);
            stopMoveCar();
        }

        function moveHandle(event) {
            var rect = joystick.getBoundingClientRect();
            var clientX = event.clientX || event.touches[0].clientX;
            var clientY = event.clientY || event.touches[0].clientY;
            var x = clientX - rect.left - handle.offsetWidth / 2;
            var y = clientY - rect.top - handle.offsetHeight / 2;
            var direction = Math.atan2(y - joystick.offsetHeight / 2, x - joystick.offsetWidth / 2);
            if (direction > -Math.PI / 4 && direction < Math.PI / 4) {
                $.get('/move/right');
            } else if (direction > Math.PI / 4 && direction < 3 * Math.PI / 4) {
                $.get('/move/backward');
            } else if (direction < -Math.PI / 4 && direction > -3 * Math.PI / 4) {
                $.get('/move/forward');
            } else {
                $.get('/move/left');
            }
            handle.style.top = y + 'px';
            handle.style.left = x + 'px';
        }

        function startMoveCar(direction) {
            clearInterval(moveInterval);
            moveInterval = setInterval(function() {
                $.get('/move/' + direction);
            }, 100);
        }

        function moveHandle2(event) {
            var rect = joystick.getBoundingClientRect();
            var clientX = event.clientX || event.touches[0].clientX;
            var clientY = event.clientY || event.touches[0].clientY;
            var x = clientX - rect.left - handle.offsetWidth / 2;
            var y = clientY - rect.top - handle.offsetHeight / 2;
            var direction = Math.atan2(y - joystick.offsetHeight / 2, x - joystick.offsetWidth / 2);
            if (direction > -Math.PI / 4 && direction < Math.PI / 4) {
                $.get('/camera/right');
            } else if (direction > Math.PI / 4 && direction < 3 * Math.PI / 4) {
                $.get('/camera/down');
            } else if (direction < -Math.PI / 4 && direction > -3 * Math.PI / 4) {
                $.get('/camera/up');
            } else {
                $.get('/camera/left');
            }
            handle2.style.top = y + 'px';
            handle2.style.left = x + 'px';
        }

        function stopMoveCar() {
            clearInterval(moveInterval);
            $.get('/move/stop');
        }
    </script>
</body>
</html>