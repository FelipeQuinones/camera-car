<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Controller</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .joystick-container-container {
            display: flex;
            justify-content: space-around;
        }
        .joystick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 25vh;
        }
        .joystick {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 200px;
            height: 200px;
            background-color: #ddd;
            border-radius: 50%;
        }
        .handle {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #bbb;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .button {
            width: 100px;
            height: 100px;
            background-color: #bbb;
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: center; align-items: center; border-radius: 50%; background-color: #bbb;">
        <img src="{{ url_for('video_feed') }}" style="width:50%;" />
    </div>

    <div style="display: flex; justify-content: center; align-items: center;">
        <button class="button" onclick="$.get('/camera/center')">Center</button>
    </div>

    <div class="joystick-container-container">
        <div class="joystick-container">
            <div id="joystick" class="joystick">
                <div id="handle" class="handle"></div>
            </div>
        </div>

        <div class="joystick-container">
            <div id="joystick2" class="joystick">
                <div id="handle2" class="handle"></div>
            </div>
        </div>
    </div>
    

    <script>
        var joystick = document.getElementById('joystick');
        var handle = document.getElementById('handle');
        var joystick2 = document.getElementById('joystick2');
        var handle2 = document.getElementById('handle2');
        var moveInterval;

        joystick.addEventListener('mousedown', startMove);
        joystick.addEventListener('touchstart', startMove);

        joystick2.addEventListener('mousedown', startMove2);
        joystick2.addEventListener('touchstart', startMove2);

        document.addEventListener('mouseup', stopMove);
        document.addEventListener('touchend', stopMove);

        function startMove(event) {
            event.preventDefault();
            moveHandle(event);
            document.addEventListener('mousemove', moveHandle);
            document.addEventListener('touchmove', moveHandle);
        }

        function startMove2(event) {
            event.preventDefault();
            moveHandle2(event);
            document.addEventListener('mousemove', moveHandle2);
            document.addEventListener('touchmove', moveHandle2);
        }

        function stopMove() {
            handle.style.top = '50%';
            handle.style.left = '50%';
            handle2.style.top = '50%';
            handle2.style.left = '50%';
            document.removeEventListener('mousemove', moveHandle);
            document.removeEventListener('touchmove', moveHandle);
            document.removeEventListener('mousemove', moveHandle2);
            document.removeEventListener('touchmove', moveHandle2);
            stopMoveCar();
            stopMoveCam();
        }

        var lastDirection = null;
        function moveHandle(event) {
            var rect = joystick.getBoundingClientRect();
            var clientX = event.clientX || event.touches[0].clientX;
            var clientY = event.clientY || event.touches[0].clientY;
            var x = clientX - rect.left - handle.offsetWidth / 2;
            var y = clientY - rect.top - handle.offsetHeight / 2;
            var direction = Math.atan2(y - joystick.offsetHeight / 2, x - joystick.offsetWidth / 2);
            
            var newDirection;
            if (direction > -Math.PI / 6 && direction < Math.PI / 6) {
                newDirection = 'right';
            } else if (direction > Math.PI / 6 && direction < Math.PI / 3) {
                newDirection = 'backward_right';
            } else if (direction > Math.PI / 3 && direction < 2 * Math.PI / 3) {
                newDirection = 'backward';
            } else if (direction > 2 * Math.PI / 3 && direction < 5 * Math.PI / 6) {
                newDirection = 'backward_left';
            } else if (direction > 5 * Math.PI / 6 || direction < -5 * Math.PI / 6) {
                newDirection = 'left';
            } else if (direction > -5 * Math.PI / 6 && direction < -2 * Math.PI / 3) {
                newDirection = 'forward_left';
            } else if (direction > -2 * Math.PI / 3 && direction < -Math.PI / 3) {
                newDirection = 'forward';
            } else if (direction > -Math.PI / 3 && direction < -Math.PI / 6) {
                newDirection = 'forward_right';
            } else {
                newDirection = null;
            }

            if (newDirection !== lastDirection) {
                startMoveCar(newDirection);
                lastDirection = newDirection;
            }

            handle.style.top = y + 'px';
            handle.style.left = x + 'px';
        }

        function startMoveCar(direction) {
            $.get('/move/' + direction);
        }

        function stopMoveCar() {
            clearInterval(moveInterval);
            lastDirection = 'stop';
            $.get('/move/stop');
        }

        var lastDirection2 = null;
        function moveHandle2(event) {
            var rect = joystick2.getBoundingClientRect(); // Use joystick2 instead of joystick
            var clientX = event.clientX || event.touches[0].clientX;
            var clientY = event.clientY || event.touches[0].clientY;
            var x = clientX - rect.left - handle2.offsetWidth / 2; // Use handle2 instead of handle
            var y = clientY - rect.top - handle2.offsetHeight / 2; // Use handle2 instead of handle
            var direction = Math.atan2(y - joystick2.offsetHeight / 2, x - joystick2.offsetWidth / 2); // Use joystick2 instead of joystick
            if (direction > -Math.PI / 4 && direction < Math.PI / 4) {
                newDirection = 'right';
            } else if (direction > Math.PI / 4 && direction < 3 * Math.PI / 4) {
                newDirection = 'down';
            } else if (direction > 3 * Math.PI / 4 || direction < -3 * Math.PI / 4) {
                newDirection = 'left';
            } else if (direction < -Math.PI / 4 && direction > -3 * Math.PI / 4) {
                newDirection = 'up';
            } else {
                newDirection = null;
            }

            handle2.style.top = y + 'px';
            handle2.style.left = x + 'px';

            if (newDirection !== lastDirection2) {
                startMoveCam(newDirection);
                lastDirection2 = newDirection;
            }
        }

        function startMoveCam(direction) {
            $.get('/camera/' + direction);
        }

        function stopMoveCam() {
            clearInterval(moveInterval);
            lastDirection2 = 'stop';
            $.get('/camera/stop');
        }

    </script>
</body>
</html>